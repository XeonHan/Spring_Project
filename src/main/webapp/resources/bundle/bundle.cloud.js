window.__define_resource&&__define_resource("MSG11680","MSG07592"),function(){ecount.httpConnection={init:function(n){this.httpConnectionFile=new ecount.httpConnectionFile(n)},send:function(n){this.init(n);this._send()},_send:function(n){this.httpConnectionFile.send(n)}}}();ecount.class("ecount.httpConnectionFile",null,{init:function(n){n.file&&(typeof n.file.getNative=="function"?(this.file=n.file.getNative(),this.pluploadFile=n.file):this.file=n.file);this.url=n.url;this.httpMethod=n.httpMethod||"POST";this.responseType=n.responseType;this.headers=n.headers||undefined;this.returnData=n.returnData;this.uploadFile=n.uploadFile;this.handler=n.handler},send:function(n){var i=this,t=new XMLHttpRequest,r;if(n&&(this.url=n),t._requestUrl=this.url,t.open(this.httpMethod,this.url,!0),this.responseType&&(t.responseType=this.responseType),this.headers)for(r in this.headers)this.headers.hasOwnProperty(r)&&t.setRequestHeader(r,this.headers[r]);t.onerror=function(n){if(i.handler){var t=i.getXMLHttpRequestSettingInfo();i.handler.onError&&i.handler.onError(n,t)}};t.onload=function(n){var r=n.type||"",t;r.toUpperCase()=="LOAD"&&(t=i.getXMLHttpRequestSettingInfo(),i.handler&&i.handler.onComplete&&i.handler.onComplete(n,this.returnData,t))};t.onloadstart=function(){};t.onreadystatechange=function(){};t.upload.onprogress=function(n){i.handler&&i.handler.onChangeStatus&&i.handler.onChangeStatus(n)};t.onprogress=function(){};t.onloadend=function(){};this.uploadFile?t.send(this.uploadFile):t.send()},getXMLHttpRequestSettingInfo:function(){var n=Object.clone(this.headers||{},!0);return _.extend(n,{url:this.url,httpMethod:this.httpMethod})}}),function(){ecount.cloudStorage={deletehttpMethod:"delete",INNER:"0",GOOGLEDRIVER:"1",ONEDRIVER:"2",DROPBOX:"3",BOX:"4",ECDRIVE:"98",deleteFileList:[],getAccessToken:function(n,t){var r=ecount.runtime.getActiveEcPageID(),f=_.isPlainObject(n)?"cloudAccessToken"+ecount.delimiter+n.account+ecount.delimiter+n.provider_seq:"cloudAccessToken",i=r?ecount.global.getPublicInfo(r,f):null,e=i?((new Date).getTime()-i.recodeTime)/1e3:null,u;i&&e!==null&&e<300?(u=null,i.data&&i.data.Data&&(u=i.data.Data.ACCESS_TOKEN),t&&t(u)):ecount.common.api({ecPageID:r,url:"/Common/Infra/GetCloudAccessToken",async:!1,data:Object.toJSON(n),success:function(i){var e,u;if(i&&i.Data)e=i.Data.ACCESS_TOKEN,r&&ecount.global.setPublicInfo(r,f,{recodeTime:(new Date).getTime(),data:i,account:i.Data.ACCOUNT}),t&&t(e);else{u="";switch(n.provider_seq){case"1":u="GoogleDrive";break;case"2":u="OneDrive";break;case"3":u="DropBox";break;case"4":u="Box"}ecount.alert(String.format(ecount.resource.MSG11680," "+u," "+n.account))}},error:function(n){ecount.alert(n.responseText)}})},deleteFile:function(n,t,i){var r=ecount.common.uuid("deleteFile");n&&(this.deleteFileList[r]={list:n.slice(0),callback:t,errCallback:i});this._deleteFile(t,i,r)},_deleteFile:function(n,t,i){var r=this.deleteFileList[i].list.shift(),u,f,e,o;r&&(u=r.provider_seq,f=r.account,u==ecount.cloudStorage.INNER?ecmodule.common.fileStorage.deleteFile(r,r,function(){self.onDeleteComplete({},i)},t):(e={provider_seq:u,account:f},o=function(n){var t=this.getConfig(r,n);t.returnData=i;ecount.httpConnection.send(t)}.bind(this),this.getAccessToken(e,o)))},getConfig:function(n,t){var i={handler:{onComplete:this.onDeleteComplete.bind(this),onError:this.onDeleteError.bind(this)}},r=n.provider_seq;switch(r){case ecount.cloudStorage.GOOGLEDRIVER:i.url="https://www.googleapis.com/drive/v3/files/"+n.id;i.headers={Authorization:"Bearer "+t};i.httpMethod="DELETE";break;case ecount.cloudStorage.ONEDRIVER:i.url="https://graph.microsoft.com/v1.0/me/drive/items/"+n.id;i.headers={Authorization:"Bearer "+t};i.httpMethod="DELETE";break;case ecount.cloudStorage.DROPBOX:i.url="https://api.dropboxapi.com/2/files/delete_v2";i.headers={Authorization:"Bearer "+t,"Content-Type":"application/json"};i.httpMethod="POST";i.uploadFile=JSON.stringify({path:n.id});break;case ecount.cloudStorage.BOX:i.url="https://api.box.com/2.0/files/"+n.id;i.headers={Authorization:"Bearer "+t,"Content-Type":"application/json"};i.httpMethod="DELETE";i.uploadFile=JSON.stringify({path:n.id})}return i},onDeleteComplete:function(n,t){n&&n.target&&[200,201,204].contains(n.target.status)==!0&&(this.deleteFileList[t].list.length>0?this._deleteFile(null,null,t):(this.deleteFileList[t].callback&&this.deleteFileList[t].callback(),delete this.deleteFileList[t]))},onDeleteError:function(){console.log("========== [file delete Error] ==========");console.log(arguments);console.log("========== [file delete Error] ==========");ecount.alert("error")},down:{_alert:function(n,t){ecount.alert(t);console.log(arguments)},googleDriver:{GET_DOWNLOAD_FILEINFO:"https://www.googleapis.com/drive/v2/files/",GET_DOWNLOAD:"https://www.googleapis.com/drive/v3/files/{0}?alt=media",getDownLoadUrl:function(n){return this.GET_DOWNLOAD_FILEINFO+n},getHeaders:function(n){return{Authorization:"Bearer "+n}},getHttpMethod:function(){return"GET"},getHandler:function(n,t){return{onComplete:function(i){this.onComplete(i,n,t)}.bind(this)}},onComplete:function(n,t,i){var r,f,u;n&&n.target&&(r=JSON.parse(n.target.response),[200,201].contains(n.target.status)?(f=r.mimeType,u=r.originalFilename,this.getDownLoadFile(u,t,i)):n.target.status==404?(ecount.alert(ecount.resource.MSG07592),console.log(r)):(console.log("========== [google file down] =========="),console.log(arguments),console.log("========== [google file down] =========="),ecount.alert("error")))},getDownLoadFile:function(n,t,i){var r=function(n,t){ecount.cloudStorage.down.getFile(n,t)},u={url:String.format(this.GET_DOWNLOAD,i),headers:{Authorization:"Bearer "+t},httpMethod:"GET",responseType:"blob",handler:{onComplete:function(t){r(t,n)}.bind(this),onError:ecount.cloudStorage.down.onError.bind(this)}};ecount.httpConnection.send(u)}},oneDrive:{GET_DOWNLOAD_FILEINFO:"https://graph.microsoft.com/v1.0/me/drive/items/{0}",GET_DOWNLOAD:"https://graph.microsoft.com/v1.0/me/drive/items/{0}/content",getDownLoadUrl:function(n){return String.format(this.GET_DOWNLOAD_FILEINFO,n)},getHeaders:function(n){return{Authorization:"Bearer "+n}},getHttpMethod:function(){return"GET"},getHandler:function(n,t){return{onComplete:function(i){this.onComplete(i,n,t)}.bind(this)}},onComplete:function(n){var t,i,r;if(n&&n.target){if(t=JSON.parse(n.target.response),[200,201].contains(n.target.status)&&(i=t.name,r=t["@microsoft.graph.downloadUrl"],!$.isEmpty(i)&&!$.isEmpty(r))){this.getDownLoadFile(i,r);return}ecount.alert(ecount.resource.MSG07592);console.log(arguments)}},getDownLoadFile:function(n,t){var i=function(n,t){n&&n.target&&n.target.status==200&&ecount.cloudStorage.down.getFile(n,t)},r={url:t,httpMethod:"GET",responseType:"blob",handler:{onComplete:function(t){i(t,n)}.bind(this),onError:ecount.cloudStorage.down.onError.bind(this)}};ecount.httpConnection.send(r)}},dropBox:{GET_DOWNLOAD:"https://content.dropboxapi.com/2/files/download",getDownLoadUrl:function(){return this.GET_DOWNLOAD},getHeaders:function(n,t){return{Authorization:"Bearer "+n,"Dropbox-API-Arg":JSON.stringify({path:t})}},getHttpMethod:function(){return"POST"},getResponseType:function(){return"blob"},getHandler:function(){return{onComplete:this.onComplete.bind(this)}},onComplete:function(n){if(n&&n.target)if(n.target.status==200||n.target.status==201){var t=JSON.parse(n.target.getResponseHeader("dropbox-api-result")).name;ecount.cloudStorage.down.getFile(n,t)}else n.target.status==409?(ecount.alert(ecount.resource.MSG07592),console.log(n.target.statusText)):(console.log("========== [dropBox file down] =========="),console.log(arguments),console.log("========== [dropBox file down] =========="),ecount.alert("error"))}},box:{GET_DOWNLOAD_FILEINFO:"https://api.box.com/2.0/files/{0}",GET_DOWNLOAD:"https://api.box.com/2.0/files/{0}/content",getDownLoadUrl:function(n){return String.format(this.GET_DOWNLOAD_FILEINFO,n)},getHeaders:function(n){return{Authorization:"Bearer "+n}},getHttpMethod:function(){return"GET"},getHandler:function(n,t){return{onComplete:function(i){this.onComplete(i,n,t)}.bind(this)}},onComplete:function(n,t,i){var r,u;n&&n.target&&(r=JSON.parse(n.target.response),[200,201].contains(n.target.status)?(u=r.name,this.getDownLoadFile(u,t,i)):n.target.status==404&&r.type=="error"?(ecount.alert(ecount.resource.MSG07592),console.log(r)):(console.log("========== [box file down] =========="),console.log(arguments),console.log("========== [box file down] =========="),ecount.alert("error")))},getDownLoadFile:function(n,t,i){var r=function(n,t){ecount.cloudStorage.down.getFile(n,t)},u={url:String.format(this.GET_DOWNLOAD,i),headers:{Authorization:"Bearer "+t},httpMethod:"GET",responseType:"blob",handler:{onComplete:function(t){r(t,n)}.bind(this),onError:ecount.cloudStorage.down.onError.bind(this)}};ecount.httpConnection.send(u)}},download:function(n){if(n.provider_seq==ecount.cloudStorage.ECDRIVE)ecmodule.common.fileSecurity.checkFileAllowed("download",[{name:n.name,size:0}],0,function(t){t==!0&&ecmodule.common.ecdrive.fileDownloadExternal(null,n.id,n.name)},ecount.runtime.getActiveEcPageID());else{var t={provider_seq:n.provider_seq,account:n.account};ecount.cloudStorage.getAccessToken(t,function(t){this._donwload(n,t)}.bind(this))}},_donwload:function(n,t){var f=n.provider_seq,r=n.id,i=this[{"1":"googleDriver","2":"oneDrive","3":"dropBox","4":"box"}[f]],u;i&&(u={url:i.getDownLoadUrl(r),headers:i.getHeaders(t,r),httpMethod:i.getHttpMethod(),responseType:i.getResponseType?i.getResponseType():undefined,handler:$.extend({},i.getHandler(t,r),{onError:this.onError.bind(this)})},ecount.httpConnection.send(u))},getFile:function(n,t){var r=n.target.response,i;window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(r,t):(i=document.createElement("a"),i.addEventListener("load",function(n){URL.revokeObjectURL(n.target.src)}),i.href=URL.createObjectURL(r),i.download=t,i.style.display="none",i.click(),delete i)},onComplete:function(n,t){t&&t(n)},onError:function(){console.log("========== [file download Error] ==========");console.log(arguments);console.log("========== [file download Error] ==========");ecount.alert("error")}}}}();